#!/usr/bin/env ruby
require 'diffy'

Diffy::Diff.default_format = :color

def assert result
  unless result
    puts 'Failed'
    exit 1
  end
  puts 'OK'
end

def assert_eq left, right
  if left == right; puts 'OK'; return; end

  puts 'Failed'
  puts " \e[32mEXPECTED\e[0m  \e[31mACTUAL\e[0m"
  puts '-'*40
  puts
  puts Diffy::Diff.new left, right
  exit 1
end



puts  'Homework 1'
print 'Homework 2 ... '
assert system 'ocaml tests/basic.ml'


print 'Homework 2.2 ... '
assert system 'ocaml tests/hw2-ex2.ml'

print 'Homework 2.7 ... '
assert_eq `ocaml tests/hw2-ex7.ml`, File.read('tests/hw2-ex7')

print 'Homework 3.1 ... '
assert_eq `sh tests/hw3.sh < tests/hw3-input`, File.read('tests/hw3-output')

print 'Homework 3.2 (COINS) ...   /100'
system 'g++ -std=c++0x -O3 tests/hw3-ex2.cc -o tests/hw3-ex2'
result = true
def test num
  `tests/hw3-ex2 #{num}` == `echo #{num} | hw3/run hw3/examples/ex2.k-`
end
test 10000
for i in 0...100
  result &&= test rand(1..10000)
  print "\b"*6 + '%2d/100' % i
end
print "\b"*6 + ' '*6 + "\b"*6
assert result

print 'Homework 3.3 ... '
tmp_path = 'tests/hw3-ex3.tmp'
code = File.read('hw3/examples/ex3.k-')
test = File.read('tests/hw3-ex3.k-')
File.write(tmp_path, code + ';' + test)
actual = `hw3/run tests/hw3-ex3.tmp`
File.delete tmp_path
assert_eq actual, File.read('tests/hw3-ex3.out')
